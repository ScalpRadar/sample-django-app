<!doctype html>

<head>
  <title>Sample Django App</title>

  <script src="https://unpkg.com/@shopify/app-bridge"></script>
  <script src="https://unpkg.com/@shopify/app-bridge-utils"></script>

  <script>

    var AppBridge = window['app-bridge'];
    var AppBridgeUtils = window['app-bridge-utils'];
    var actions = AppBridge.actions;
    var createApp = AppBridge.default;
    var TitleBar = actions.TitleBar;
    var app = createApp({
      apiKey: '{{ api_key }}',
      shopOrigin: '{{ shop_origin }}'
    });
    var myTitleBar = TitleBar.create(app, { title: 'Hello' });
    var shopifyAuthenticatedFetch = AppBridgeUtils.authenticatedFetch(app);
    var redirect = actions.Redirect.create(app);

    function topLevelRedirectToLogin() {
      redirect.dispatch(actions.Redirect.Action.REMOTE, `${app.localOrigin}/login?shop={{ shop_origin }}`);
    }

    function setStatusMessage(message) {
        document.getElementById('status-messages').innerText = message;
    }

    function performSync(endpoint, method, description) {
        fetch(endpoint + '?shop={{ shop_origin }}', {
            method: method,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to ${description} with status: ` + response.status);
            }
            return response.text();
        })
        .then(text => {
            setStatusMessage(`${description} successfully: ` + text);
        })
        .catch(error => {
            setStatusMessage(`Error ${description}: ` + error.message);
        });
    }

    function syncOrders() {
        performSync('shopify/sync/orders/', 'POST', 'sync orders');
    }

    function syncProducts() {
        performSync('shopify/sync/products/', 'POST', 'sync products');
    }

    function syncCustomers() {
        performSync('shopify/sync/customers/', 'POST', 'sync customers');
    }

    function confirmDelete() {
        return confirm('Are you sure you want to delete this webhook?');
    }
  </script>
</head>

<body>
    <h1>Admin</h1>

    <button onclick="syncOrders()">Sync Orders</button>
    <button onclick="syncProducts()">Sync Products</button>
    <button onclick="syncCustomers()">Sync Customers</button>

    <p id="status-messages"></p>

    <h2>Webhooks</h2>

    <h3>Add Order Webhook</h3>
    <form method="post" action="">
      {% csrf_token %}
      <input type="hidden" name="add_webhook" value="1">
      <input type="text" name="topic" placeholder="Topic">
      <input type="url" name="address" placeholder="Callback URL">
      <button type="submit">Add Webhook</button>
    </form>

    <h3>View</h3>
    {% for webhook in webhooks %}
    <form method="post" action="">
      {% csrf_token %}
      <input type="hidden" name="delete_webhook" value="1">
      <input type="hidden" name="webhook_id" value="{{ webhook.id }}">
      <p>ID: {{ webhook.id }}</p>
      <p>Topic: {{ webhook.topic }}</p>
      <p>Address: {{ webhook.address }}</p>
      <button type="submit" onclick="return confirmDelete();">Delete</button>
    </form>
    <br>
    {% endfor %}

    <!-- Modal to indicate login is needed -->
    {% if scope_changes_required %}
    <div>
      <div id="PolarisPortalsContainer">
        <div data-portal-id="modal-Polarisportal2">
          <div>
            <div class="Polaris-Modal-Dialog__Container" data-polaris-layer="true" data-polaris-overlay="true">
              <div>
                <div role="dialog" aria-modal="true" aria-labelledby="Polarismodal-header2" tabindex="-1"
                  class="Polaris-Modal-Dialog focus-visible" data-focus-visible-added="">
                  <div class="Polaris-Modal-Dialog__Modal">
                    <div class="Polaris-Modal-Header">
                      <div id="Polarismodal-header2" class="Polaris-Modal-Header__Title">
                        <h2 class="Polaris-DisplayText Polaris-DisplayText--sizeSmall">
                          The app needs to login
                        </h2>
                      </div>
                    </div>
                    <div class="Polaris-Modal__BodyWrapper">
                      <div class="Polaris-Modal__Body Polaris-Scrollable Polaris-Scrollable--vertical"
                        data-polaris-scrollable="true">
                        <section class="Polaris-Modal-Section">
                          <div class="Polaris-TextContainer">
                            <p>
                              While you were away, changes were made to the app that require you to login again.
                            </p>
                          </div>
                        </section>
                      </div>
                    </div>
                    <div class="Polaris-Modal-Footer">
                      <div class="Polaris-Modal-Footer__FooterContent">
                        <div class="Polaris-Stack Polaris-Stack--alignmentCenter">
                          <div class="Polaris-Stack__Item Polaris-Stack__Item--fill"></div>
                          <div class="Polaris-Stack__Item">
                            <div class="Polaris-ButtonGroup">
                              <div class="Polaris-ButtonGroup__Item"><button onclick="topLevelRedirectToLogin()"
                                  class="Polaris-Button Polaris-Button--primary" type="button"><span
                                    class="Polaris-Button__Content"><span class="Polaris-Button__Text">Login
                                    </span></span></button></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="Polaris-Backdrop"></div>
        </div>
      </div>
    </div>
    <div class="Polaris-Backdrop"></div>
    {% endif %}
  </div>
</body>
